<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Sessions - Memorybank</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 20px; }
        pre {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .info {
            background: #e7f3ff;
            padding: 10px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
        }
        .warning {
            background: #fff3cd;
            padding: 10px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            padding: 10px;
            border-left: 4px solid #28a745;
            margin: 10px 0;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Memorybank Session Debugger</h1>

    <div class="container">
        <h2>Current localStorage State</h2>
        <button onclick="showAllKeys()">Show All Keys</button>
        <button onclick="location.reload()">Refresh</button>
        <div id="allKeys"></div>
    </div>

    <div class="container">
        <h2>Session Data</h2>
        <button onclick="showSessions()">Show Current Sessions</button>
        <button onclick="showOldSessions()">Check Old Keys (membank_*)</button>
        <div id="sessionData"></div>
    </div>

    <div class="container">
        <h2>Add Missing Session</h2>
        <div class="info">
            If you remember the user ID of your "memory user" session, you can add it back here.
        </div>
        <input type="text" id="userId" placeholder="User ID (e.g., memory_user)" />
        <input type="text" id="sessionName" placeholder="Session Name (e.g., Memory User)" />
        <button onclick="addSession()">Add Session</button>
        <div id="addResult"></div>
    </div>

    <div class="container">
        <h2>Manual Migration</h2>
        <div class="warning">
            Use this if you found old session data in membank_sessions
        </div>
        <button onclick="migrateFromOld()">Migrate from membank_sessions</button>
        <button class="danger" onclick="resetSessions()">Reset All Sessions</button>
        <div id="migrationResult"></div>
    </div>

    <div class="container">
        <h2>Backend User Directories</h2>
        <button onclick="fetchBackendUsers()">Fetch Users from Backend</button>
        <div id="backendUsers"></div>
    </div>

    <script>
        function showAllKeys() {
            const div = document.getElementById('allKeys');
            const keys = Object.keys(localStorage);

            if (keys.length === 0) {
                div.innerHTML = '<pre>No localStorage keys found</pre>';
                return;
            }

            let html = '<pre>';
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                html += `<strong>${key}</strong>:\n${value}\n\n`;
            });
            html += '</pre>';
            div.innerHTML = html;
        }

        function showSessions() {
            const div = document.getElementById('sessionData');
            const sessionsData = localStorage.getItem('memorybank_sessions');
            const activeSession = localStorage.getItem('memorybank_active_session');

            if (!sessionsData) {
                div.innerHTML = '<div class="warning">No memorybank_sessions found in localStorage</div>';
                return;
            }

            try {
                const sessions = JSON.parse(sessionsData);
                let html = '<div class="success">Found ' + sessions.length + ' session(s)</div>';
                html += '<pre>' + JSON.stringify({ sessions, activeSession }, null, 2) + '</pre>';
                div.innerHTML = html;
            } catch (e) {
                div.innerHTML = '<div class="warning">Error parsing sessions: ' + e.message + '</div>';
            }
        }

        function showOldSessions() {
            const div = document.getElementById('sessionData');
            const oldSessions = localStorage.getItem('membank_sessions');
            const oldActive = localStorage.getItem('membank_active_session');

            if (!oldSessions) {
                div.innerHTML = '<div class="warning">No membank_sessions found (might have been migrated already)</div>';
                return;
            }

            try {
                const sessions = JSON.parse(oldSessions);
                let html = '<div class="info">Found OLD sessions data (not migrated)!</div>';
                html += '<pre>' + JSON.stringify({ sessions, oldActive }, null, 2) + '</pre>';
                div.innerHTML = html;
            } catch (e) {
                div.innerHTML = '<div class="warning">Error parsing old sessions: ' + e.message + '</div>';
            }
        }

        function addSession() {
            const userId = document.getElementById('userId').value.trim();
            const sessionName = document.getElementById('sessionName').value.trim();
            const resultDiv = document.getElementById('addResult');

            if (!userId) {
                resultDiv.innerHTML = '<div class="warning">Please enter a user ID</div>';
                return;
            }

            try {
                // Get current sessions
                let sessions = [];
                const stored = localStorage.getItem('memorybank_sessions');
                if (stored) {
                    sessions = JSON.parse(stored);
                }

                // Check if session already exists
                const exists = sessions.find(s => s.id === userId);
                if (exists) {
                    resultDiv.innerHTML = '<div class="warning">Session with this ID already exists!</div>';
                    return;
                }

                // Add new session
                const newSession = {
                    id: userId,
                    name: sessionName || userId,
                    createdAt: new Date().toISOString()
                };
                sessions.push(newSession);

                // Save
                localStorage.setItem('memorybank_sessions', JSON.stringify(sessions));

                resultDiv.innerHTML = '<div class="success">Session added successfully! Refresh the page.</div>';
                showSessions();
            } catch (e) {
                resultDiv.innerHTML = '<div class="warning">Error: ' + e.message + '</div>';
            }
        }

        function migrateFromOld() {
            const resultDiv = document.getElementById('migrationResult');
            const oldSessions = localStorage.getItem('membank_sessions');

            if (!oldSessions) {
                resultDiv.innerHTML = '<div class="warning">No membank_sessions found to migrate</div>';
                return;
            }

            try {
                // Copy to new key
                localStorage.setItem('memorybank_sessions', oldSessions);

                // Migrate active session too
                const oldActive = localStorage.getItem('membank_active_session');
                if (oldActive) {
                    localStorage.setItem('memorybank_active_session', oldActive);
                }

                // Remove old keys
                localStorage.removeItem('membank_sessions');
                localStorage.removeItem('membank_active_session');

                resultDiv.innerHTML = '<div class="success">Migration complete! Refresh the page to see your sessions.</div>';
                showSessions();
            } catch (e) {
                resultDiv.innerHTML = '<div class="warning">Error during migration: ' + e.message + '</div>';
            }
        }

        function resetSessions() {
            if (!confirm('Are you sure? This will clear ALL session data!')) {
                return;
            }

            localStorage.removeItem('memorybank_sessions');
            localStorage.removeItem('memorybank_active_session');
            localStorage.removeItem('membank_sessions');
            localStorage.removeItem('membank_active_session');

            document.getElementById('migrationResult').innerHTML =
                '<div class="success">All session data cleared. Refresh the page to start fresh.</div>';
        }

        async function fetchBackendUsers() {
            const div = document.getElementById('backendUsers');
            div.innerHTML = '<div class="info">Fetching user directories from backend...</div>';

            try {
                // Try to get a list of users from the API
                // Note: This requires an endpoint that lists users, which might not exist
                div.innerHTML = '<div class="warning">This feature requires a backend endpoint to list users. You can check the users/ directory on the server directly.</div>';

                // Alternatively, show current sessions that might have user data
                const sessionsData = localStorage.getItem('memorybank_sessions');
                if (sessionsData) {
                    const sessions = JSON.parse(sessionsData);
                    let html = '<h3>Sessions in localStorage (these user IDs should have backend data):</h3><ul>';
                    sessions.forEach(s => {
                        html += `<li><strong>${s.name}</strong> (${s.id})</li>`;
                    });
                    html += '</ul>';
                    div.innerHTML += html;
                }
            } catch (e) {
                div.innerHTML = '<div class="warning">Error: ' + e.message + '</div>';
            }
        }

        // Auto-load on page load
        window.onload = function() {
            showAllKeys();
            showSessions();
        };
    </script>
</body>
</html>
